---
- name: Install packages - epel-release
  yum:
    name:
      - epel-release
    state: present

- name: Install python-pip, python-devel, gcc, nginx
  yum:
    name:
      - python-pip
      - python-devel
      - gcc
      - nginx
    state: present

- name: Create the project group myprojectuser.
  group: 
    name: myprojectuser
    state: present

- name: Create the project user myprojectuser.
  user:
    name: myprojectuser
    uid: 1040
    group: myprojectuser

- name: Install virtualenv
  pip:
    name: virtualenv

- name: Create virtualenv
  shell: /usr/bin/virtualenv /home/myprojectuser/myprojectenv

- name: Assign the owner and group myprojectuser rwx permissions on the user home directory.
  file:
    path: /home/myprojectuser
    owner: myprojectuser
    group: myprojectuser
    recurse: yes
    mode: 0770

- name: Install flask and gunicorn in myprojectenv
  pip:
    name: 
      - flask
      - gunicorn
    virtualenv: /home/myprojectuser/myprojectenv

- name: Create directory myproject.
  file:
    path: /home/myprojectuser/myproject
    state: directory
    owner: myprojectuser
    group: myprojectuser
    recurse: yes
    mode: 0770

- name: Copy myproject.py flask app template into the VM.
  template:
    src: myproject.py
    dest: /home/myprojectuser/myproject
    owner: myprojectuser
    group: myprojectuser
    directory_mode: yes
    mode: u=rwx,g=x

- name: Copy wsgi.py entry point template into the VM.
  template:
    src: wsgi.py
    dest: /home/myprojectuser/myproject
    owner: myprojectuser
    group: myprojectuser
    directory_mode: yes
    mode: u=rwx,g=x

- name: Copy the service template file for myproject into /etc/systemd/system.
  template:
    src: myproject.service
    dest: /etc/systemd/system
  notify: Start and enable the myproject service.
